"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[574],{3905:function(e,t,a){a.d(t,{Zo:function(){return d},kt:function(){return h}});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},d=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,l=e.originalType,s=e.parentName,d=r(e,["components","mdxType","originalType","parentName"]),c=p(a),h=i,m=c["".concat(s,".").concat(h)]||c[h]||u[h]||l;return a?n.createElement(m,o(o({ref:t},d),{},{components:a})):n.createElement(m,o({ref:t},d))}));function h(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var l=a.length,o=new Array(l);o[0]=c;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r.mdxType="string"==typeof e?e:i,o[1]=r;for(var p=2;p<l;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},3849:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return r},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return d},default:function(){return c}});var n=a(7462),i=a(3366),l=(a(7294),a(3905)),o=["components"],r={sidebar_position:22},s="Migrate an existing Digital.ai Deploy installation to Kubernetes (v23.3 and v24.1)",p={unversionedId:"migration-deploy-from-on-prem-to-k8s",id:"migration-deploy-from-on-prem-to-k8s",isDocsHomePage:!1,title:"Migrate an existing Digital.ai Deploy installation to Kubernetes (v23.3 and v24.1)",description:"This is internal documentation.",source:"@site/docs/migration-deploy-from-on-prem-to-k8s.md",sourceDirName:".",slug:"/migration-deploy-from-on-prem-to-k8s",permalink:"/xl-deploy-kubernetes-helm-chart/docs/migration-deploy-from-on-prem-to-k8s",tags:[],version:"current",sidebarPosition:22,frontMatter:{sidebar_position:22},sidebar:"tutorialSidebar",previous:{title:"RBAC rules for the Deploy installation",permalink:"/xl-deploy-kubernetes-helm-chart/docs/operator-rbac"}},d=[{value:"1. Preparation",id:"1-preparation",children:[{value:"1.1. Requirements for Client Machine",id:"11-requirements-for-client-machine",children:[{value:"Mandatory",id:"mandatory",children:[],level:4},{value:"Optional",id:"optional",children:[],level:4}],level:3},{value:"1.2. Select the Desired Cloud Platform for Migration",id:"12-select-the-desired-cloud-platform-for-migration",children:[],level:3},{value:"1.3. Provide Docker Image Tags",id:"13-provide-docker-image-tags",children:[],level:3},{value:"1.4. Deploy Server Replicas",id:"14-deploy-server-replicas",children:[],level:3},{value:"1.5. Configure your Kubernetes Cluster",id:"15-configure-your-kubernetes-cluster",children:[{value:"1.5.1. Resource Sizing",id:"151-resource-sizing",children:[],level:4},{value:"1.5.2. Namespace",id:"152-namespace",children:[],level:4},{value:"1.5.3. License",id:"153-license",children:[],level:4},{value:"1.5.4. Repository Keystore File",id:"154-repository-keystore-file",children:[],level:4},{value:"1.5.5. Relational Database",id:"155-relational-database",children:[],level:4},{value:"1.5.6. Message Queue",id:"156-message-queue",children:[],level:4},{value:"1.5.7. Authentication",id:"157-authentication",children:[],level:4},{value:"1.5.8. Storage",id:"158-storage",children:[],level:4}],level:3}],level:2},{value:"2. Upgrade Deploy on the Target Version",id:"2-upgrade-deploy-on-the-target-version",children:[],level:2},{value:"3. Switch Artifact Storage to Database",id:"3-switch-artifact-storage-to-database",children:[],level:2},{value:"4. Switch Plugin Source to Database",id:"4-switch-plugin-source-to-database",children:[],level:2},{value:"5. Backup Current Installation",id:"5-backup-current-installation",children:[{value:"5.1. Drain Ongoing Tasks from Deploy",id:"51-drain-ongoing-tasks-from-deploy",children:[],level:3},{value:"5.2. Shut down the existing Deploy server.",id:"52-shut-down-the-existing-deploy-server",children:[],level:3},{value:"5.3. Backup database",id:"53-backup-database",children:[],level:3},{value:"5.4. Backup all customized Deploy directories",id:"54-backup-all-customized-deploy-directories",children:[],level:3}],level:2},{value:"6. Installation Deploy Digital.ai on K8S Cluster",id:"6-installation-deploy-digitalai-on-k8s-cluster",children:[{value:"6.1. Generate K8S Configuration",id:"61-generate-k8s-configuration",children:[],level:3},{value:"6.2. Resource Configuration",id:"62-resource-configuration",children:[],level:3},{value:"6.3. Configuration file changes (optional)",id:"63-configuration-file-changes-optional",children:[],level:3},{value:"6.4. Other customizations (optional)",id:"64-other-customizations-optional",children:[{value:"6.4.1. Truststore",id:"641-truststore",children:[],level:4},{value:"6.4.2. Set up JVM Arguments",id:"642-set-up-jvm-arguments",children:[],level:4},{value:"6.4.3. Set up file logging",id:"643-set-up-file-logging",children:[],level:4}],level:3},{value:"6.5. Test the Setup with Temporary Installation (optional)",id:"65-test-the-setup-with-temporary-installation-optional",children:[{value:"6.5.1 Change database configuration to temporary database",id:"651-change-database-configuration-to-temporary-database",children:[],level:4},{value:"6.5.2. Apply temporary installation to cluster",id:"652-apply-temporary-installation-to-cluster",children:[],level:4},{value:"6.5.3. Check the Test Installation",id:"653-check-the-test-installation",children:[],level:4},{value:"6.5.4. Restore the Database Configuration",id:"654-restore-the-database-configuration",children:[],level:4}],level:3},{value:"6.6. Restore Data to Target DB (optional)",id:"66-restore-data-to-target-db-optional",children:[{value:"6.6.1 Change replica count for master and worker",id:"661-change-replica-count-for-master-and-worker",children:[],level:4},{value:"6.6.2. Apply temporary installation to cluster",id:"662-apply-temporary-installation-to-cluster",children:[],level:4},{value:"6.6.3. Restore the Data",id:"663-restore-the-data",children:[],level:4}],level:3},{value:"6.7. Apply the Setup on K8S Cluster",id:"67-apply-the-setup-on-k8s-cluster",children:[],level:3},{value:"6.7.1 Review the <code>dai-deploy_cr.yaml</code>",id:"671-review-the-dai-deploy_cryaml",children:[],level:3},{value:"6.7.2 Apply final installation to cluster",id:"672-apply-final-installation-to-cluster",children:[],level:3}],level:2},{value:"7. Check the Installation",id:"7-check-the-installation",children:[{value:"7.1 Check the resources",id:"71-check-the-resources",children:[],level:3},{value:"7.2 Check the connection",id:"72-check-the-connection",children:[],level:3}],level:2},{value:"8. Rollback",id:"8-rollback",children:[{value:"8.1. Clean Current Installation from K8S Cluster",id:"81-clean-current-installation-from-k8s-cluster",children:[],level:3},{value:"8.2. Start back on-prem Deploy",id:"82-start-back-on-prem-deploy",children:[],level:3}],level:2},{value:"9. Final Notes",id:"9-final-notes",children:[],level:2}],u={toc:d};function c(e){var t=e.components,r=(0,i.Z)(e,o);return(0,l.kt)("wrapper",(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"migrate-an-existing-digitalai-deploy-installation-to-kubernetes-v233-and-v241"},"Migrate an existing Digital.ai Deploy installation to Kubernetes (v23.3 and v24.1)"),(0,l.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"This is internal documentation.\nThe document can be used only if it was recommended by the Support Team."))),(0,l.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"This document is for a Deploy version from 23.3 and up."))),(0,l.kt)("p",null,"Following steps should cover the general process of moving your Digital.ai software onto a Kubernetes platform.\nNote that details can vary depending on your specific situation, needs, and pre-existing infrastructure."),(0,l.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),":")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"This guide is technical in nature. Before starting the migration process, make sure you have a proficient level of understanding about your\nexisting infrastructure, Kubernetes, and the Digital.ai Deploy products.\nIf you have more specific questions about any of these steps, feel free to ask!"))),(0,l.kt)("h2",{id:"1-preparation"},"1. Preparation"),(0,l.kt)("p",null,"Make sure all necessary prerequisites are in place. These include things like:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"setting up your Kubernetes cluster, "),(0,l.kt)("li",{parentName:"ul"},"installing and configuring required Kubernetes CLI tools, "),(0,l.kt)("li",{parentName:"ul"},"preparing necessary information for PostgreSQL and RabbitMQ servers if existing ones are to be used.")),(0,l.kt)("p",null,":::TIP\nRead through the xl kube workshop to gain a comprehensive understanding of how to install or upgrade Digital.ai Deploy or Release or Remote Runner on a kubernetes cluster.\nSee:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/xebialabs/xl-kube-workshop"},"xl-kube-workshop")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/xebialabs/xl-deploy-kubernetes-helm-chart/tree/23.3.x-maintenance"},"Helm chart documentation")," - the Deploy operator is managing Deploy helm chart on K8S cluster\n:::")),(0,l.kt)("p",null,"This manual is for 23.3 and 24.1 versions (or above).\nThe target version of Deploy needs to be aligned with tools used (xl), and supported java version.\nAlso, the version of on-prem Deploy before migration needs to be the same to the target version of the Deploy that will be installed on K8S cluster."),(0,l.kt)("h3",{id:"11-requirements-for-client-machine"},"1.1. Requirements for Client Machine"),(0,l.kt)("h4",{id:"mandatory"},"Mandatory"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Installed ",(0,l.kt)("a",{parentName:"li",href:"https://dist.xebialabs.com/public/xl-cli/"},"xl")," - same version of the Deploy you plan to install on K8S cluster",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/how-to/install-the-xl-cli.html"},"Install the XL CLI")))),(0,l.kt)("li",{parentName:"ul"},"Installed ",(0,l.kt)("a",{parentName:"li",href:"https://github.com/mikefarah/yq"},"yq")," 4.18.1 or higher."),(0,l.kt)("li",{parentName:"ul"},"Installed ",(0,l.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/tools/"},"kubectl")," version +/-1 from the target K8S cluster version."),(0,l.kt)("li",{parentName:"ul"},"Network connection to the selected K8S cluster with kubectl context setup")),(0,l.kt)("h4",{id:"optional"},"Optional"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Installed Java 11/17 - keytool (only if you plan to use the generation of the keystore from the xl-cli kube) - the version depends on Deploy's Java version"),(0,l.kt)("li",{parentName:"ul"},"Installed ",(0,l.kt)("a",{parentName:"li",href:"https://helm.sh/docs/intro/install/"},"helm")," - if you would like to get additional info during installation - the latest version"),(0,l.kt)("li",{parentName:"ul"},"Installed docker image registry compatible cli to push/pull images - if you need to pull/push images from ",(0,l.kt)("inlineCode",{parentName:"li"},"docker.io")," to the private K8S image registry",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.docker.com/get-docker/"},"docker-cli")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://podman.io/docs/installation"},"podman-cli")," - as alternative to docker cli to push/pull images")))),(0,l.kt)("h3",{id:"12-select-the-desired-cloud-platform-for-migration"},"1.2. Select the Desired Cloud Platform for Migration"),(0,l.kt)("p",null,"The migration supports multiple platforms including (here are also links with some details that are important for the specific provider):"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Plain Multi-node Kubernetes Cluster On-premise, "),(0,l.kt)("li",{parentName:"ul"},"OpenShift (on ",(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-install-on-aws-openshift.html"},"AWS"),", Azure and on other providers), "),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-install-on-eks.html"},"Amazon EKS"),", "),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-install-on-gke.html"},"Google GKE"),", and "),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-install-on-aks.html"},"Azure AKS"),".")),(0,l.kt)("h3",{id:"13-provide-docker-image-tags"},"1.3. Provide Docker Image Tags"),(0,l.kt)("p",null,"While the default (latest) Docker image tags will be used, it's possible to verify all available tags using the corresponding Docker Hub links. "),(0,l.kt)("p",null,"Here is the list of images for 23.3 version: ",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-setup-custom-image-registry.html#step-1-get-prerequisite-images"},"Prerequisite Images"),".\nCheck if all images are available on your K8s cluster."),(0,l.kt)("p",null,"If you plan to use private image registry, check how to setup it during installation:\n",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-deploy-airgapped-install.html"},"Install or Upgrade Deploy on an Air-gaped Environment")),(0,l.kt)("h3",{id:"14-deploy-server-replicas"},"1.4. Deploy Server Replicas"),(0,l.kt)("p",null,"Estimate the number of master and worker replicas required for your Deploy installation and the resources that are needed on cluster.\nWith that estimate check have you enough the number of nodes in the K8S cluster. "),(0,l.kt)("h3",{id:"15-configure-your-kubernetes-cluster"},"1.5. Configure your Kubernetes Cluster"),(0,l.kt)("h4",{id:"151-resource-sizing"},"1.5.1. Resource Sizing"),(0,l.kt)("p",null,"Plan the sizing of the pods master/worker resources. Check resources that are needed for normal installation, the sizing of the master and worker pods should be the same:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/requirements-for-installing-xl-deploy.html#external-worker-hardware-configuration"},"External Worker Hardware Configuration")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/requirements-for-installing-xl-deploy.html#hard-disk"},"Hard Disk"))),(0,l.kt)("h4",{id:"152-namespace"},"1.5.2. Namespace"),(0,l.kt)("p",null,"Define a namespace for the installation. By default, it's ",(0,l.kt)("inlineCode",{parentName:"p"},"digitalai"),", but a custom namespace can be used."),(0,l.kt)("p",null,"Choose the Ingress Controller to use. Nginx and HAProxy are supported, or you can use existing ingress class from K8S cluster, or no ingress."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"You will need a registered domain name (FQDN) to access the UI."),(0,l.kt)("li",{parentName:"ul"},"Possibly enable SSL/TLS protocols in your cluster. If so, you will need to create a TLS certificate and key as a secret in your cluster.")),(0,l.kt)("h4",{id:"153-license"},"1.5.3. License"),(0,l.kt)("p",null,"Have a valid license for the services to be installed. License files can be in plain text format or base64 encoded format.\nSee ",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/xl-deploy-licensing.html"},"Licensing the Deploy Product")),(0,l.kt)("h4",{id:"154-repository-keystore-file"},"1.5.4. Repository Keystore File"),(0,l.kt)("p",null,"Copy your repository keystore file ",(0,l.kt)("inlineCode",{parentName:"p"},"repository-keystore.jceks")," and keystore password in clear-text from the Deploy conf directory to the client machine.\nThe keystore file is in the ",(0,l.kt)("inlineCode",{parentName:"p"},"conf")," directory of your existing Deploy instance: ",(0,l.kt)("inlineCode",{parentName:"p"},"conf/repository-keystore.jceks"),", it contains an encryption key for DB repository.\nYou need to reuse that file during ",(0,l.kt)("inlineCode",{parentName:"p"},"xl kube install")," installation in the step 6.1."),(0,l.kt)("h4",{id:"155-relational-database"},"1.5.5. Relational Database"),(0,l.kt)("p",null,"Choose whether you will be using database:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"an existing relational database server supported by Deploy's target version, or "),(0,l.kt)("li",{parentName:"ul"},"create new one external relational database supported by Deploy, or "),(0,l.kt)("li",{parentName:"ul"},"create a new one PostgreSQL database during the installation that will run inside the Kubernetes cluster.\nIf the former, there is some required information you will need to gather. Check the list of supported databases and version, and storage sizing:"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/requirements-for-installing-xl-deploy.html#supported-databases"},"Supported Databases")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/requirements-for-installing-xl-deploy.html#database-server-hardware-configuration"},"Database Server Hardware Configuration")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-deploy-external-db.html"},"Using an Existing PostgreSQL Database"))),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"If you plan to use an external database, pay attention to the latency between your cluster and DB instance, it will play a big part in the final Deploy performance."))),(0,l.kt)("h4",{id:"156-message-queue"},"1.5.6. Message Queue"),(0,l.kt)("p",null,"The same decision and process also applies to RabbitMQ server (as for Relational Database)."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-deploy-external-mq.html"},"Using an Existing RabbitMQ Message Queue"))),(0,l.kt)("h4",{id:"157-authentication"},"1.5.7. Authentication"),(0,l.kt)("p",null,"Optionally, configure OIDC for authentication. It can be:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"an existing server such as ",(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/deploy-oidc-with-keycloak.html"},"Keycloak"),", ",(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/xl-deploy-oidc-authentication.html"},"Okta, Azure Active Directory"),";"),(0,l.kt)("li",{parentName:"ul"},"integrated with ",(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/how-to/deploy-integrating-with-identity-service.html"},"Digital.ai's Identity Service platform"),"; "),(0,l.kt)("li",{parentName:"ul"},"integrated with ",(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/how-to/setup-and-configuration-LDAP-with-deploy.html"},"LDAP")," "),(0,l.kt)("li",{parentName:"ul"},"or use no OIDC authentication in favor of Digital.ai's own DB-based local user authentication.")),(0,l.kt)("p",null,"Check the selection details in the documentation ",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/deploy-plan-your-sso-authentication.html"},"SSO Authentication Options")),(0,l.kt)("p",null,"Configuration of the OIDC part is done during xl kube installation, check documentation: ",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-deploy-install-oidc-configuration.html"},"Select the Type of OIDC Configuration")),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"If you plan to use an LDAP, it requires update of the file ",(0,l.kt)("inlineCode",{parentName:"p"},"conf/deployit-security.xml"),", there is an example how to customize that file in\n",(0,l.kt)("a",{target:"_blank",href:a(6633).Z},"dai-deploy_cr-example.yaml"),". Check the section in the file\n",(0,l.kt)("inlineCode",{parentName:"p"},"spec.master.extraConfiguration.default-conf_deployit-security")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.worker.extraConfiguration.default-conf_deployit-security"),", and in this document section 6.3. how to do changes. "))),(0,l.kt)("h4",{id:"158-storage"},"1.5.8. Storage"),(0,l.kt)("p",null,"Estimate PVC size for Deploy masters and workers, PostgreSQL, and RabbitMQ:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/requirements-for-installing-xl-deploy.html#hard-disk"},"Hard Disk")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/requirements-for-installing-xl-deploy.html#database-server-hardware-configuration"},"Database Server Hardware Configuration"))),(0,l.kt)("p",null,"Select the storage class, for the Deploy is enough to use any ReadWriteOnce access mode supported storage class.\nDefault storage classes are created in Kubernetes clusters that run Kubernetes version 1.22 or later, but you can create your own to suit your needs.\nCheck details on the tested storage classes: ",(0,l.kt)("a",{parentName:"p",href:"https://digitalai.atlassian.net/wiki/spaces/Labs/pages/77226606593/Storage+class+support"},"Storage class support (not public, ask for the copy)")),(0,l.kt)("h2",{id:"2-upgrade-deploy-on-the-target-version"},"2. Upgrade Deploy on the Target Version"),(0,l.kt)("p",null,"It is expected that migration of the Deploy to the K8S cluster will be done with the same version of the Deploy (during the migration, there will be no upgrade of the version)."),(0,l.kt)("p",null,"For more details, check ",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/how-to/upgrade-xl-deploy.html"},"Upgrade Deploy 10.1.x or Later to Current")),(0,l.kt)("h2",{id:"3-switch-artifact-storage-to-database"},"3. Switch Artifact Storage to Database"),(0,l.kt)("p",null,"The K8S version of the Deploy is working with the database artifact storage.\nIn case you are already using the database, you have the following configuration: "),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"XL_DEPLOY_SERVER_HOME/centralConfiguration/deploy-repository.yaml")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"xl.repository:\n  artifacts:\n    type: db\n")),(0,l.kt)("p",null,"In the other way for more details, check:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/how-to/move-artifacts.html"},"Move artifacts from the file system to a database")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/how-to/configure-the-xl-deploy-sql-repository.html"},"Configure the Database and Artifacts Repository"))),(0,l.kt)("h2",{id:"4-switch-plugin-source-to-database"},"4. Switch Plugin Source to Database"),(0,l.kt)("p",null,"The K8S version of the Deploy is working with the database plugin source.\nIn case you are already using the database - ",(0,l.kt)("inlineCode",{parentName:"p"},"-plugin-source database"),", skip this section."),(0,l.kt)("p",null,"In the other way for more details, check:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/concept/plugins-synchronization.html"},"Plugin synchronization"))),(0,l.kt)("p",null,"With this option enabled before migration, all plugins will be stored in the database. "),(0,l.kt)("h2",{id:"5-backup-current-installation"},"5. Backup Current Installation"),(0,l.kt)("h3",{id:"51-drain-ongoing-tasks-from-deploy"},"5.1. Drain Ongoing Tasks from Deploy"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Log in to your existing Deploy instance as an administrator, click Explorer, expand Monitoring, double click Deployment tasks, and select All Tasks."),(0,l.kt)("li",{parentName:"ul"},"If there are any tasks with a state of Failing or Failed, cancel them."),(0,l.kt)("li",{parentName:"ul"},"If there are any tasks with a state of Executing, wait for them to complete or cancel them."),(0,l.kt)("li",{parentName:"ul"},"To open a task from Monitoring, double-click it."),(0,l.kt)("li",{parentName:"ul"},"Ensure that no new tasks are started by enabling ",(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/how-to/enable-xl-deploy-maintenance-mode.html"},"maintenance mode"),".")),(0,l.kt)("h3",{id:"52-shut-down-the-existing-deploy-server"},"5.2. Shut down the existing Deploy server."),(0,l.kt)("h3",{id:"53-backup-database"},"5.3. Backup database"),(0,l.kt)("p",null,"Back up your database installations, here is an example with a separated main and report PostgreSQL database:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"mkdir -p /tmp/postgresql/backup\npg_dump -U xld xld-db | gzip > /tmp/postgresql/backup/pg_dump-xld-db.sql.gzip\n# execute this if you have separate xld-report-db \npg_dump -U xld-report xld-report-db | gzip > /tmp/postgresql/backup/pg_dump-xld-report-db.sql.gzip\n")),(0,l.kt)("p",null,"Use the database username and password according to your PostgreSQL database setup."),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"Make sure that the directory where you are storing backup has enough free space."))),(0,l.kt)("h3",{id:"54-backup-all-customized-deploy-directories"},"5.4. Backup all customized Deploy directories"),(0,l.kt)("p",null,"For example, possible changes could be in directories:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"conf"),(0,l.kt)("li",{parentName:"ul"},"ext"),(0,l.kt)("li",{parentName:"ul"},"hotfix"),(0,l.kt)("li",{parentName:"ul"},"work")),(0,l.kt)("p",null,"See details for the backup: ",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/how-to/back-up-xl-deploy.html"},"Back up Deploy")),(0,l.kt)("h2",{id:"6-installation-deploy-digitalai-on-k8s-cluster"},"6. Installation Deploy Digital.ai on K8S Cluster"),(0,l.kt)("h3",{id:"61-generate-k8s-configuration"},"6.1. Generate K8S Configuration"),(0,l.kt)("p",null,"Use the "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"xl kube install --dry-run\n")),(0,l.kt)("p",null,"command from the XL CLI to generate initial installation files for Digital.ai Deploy."),(0,l.kt)("p",null,"During execution, you will need prepared items from section 1.5.\nUse the collected information from the previous steps to answer the questions and do initial generation of the resource files for the target namespace.\nAbout setup check for details in the documentation:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-install-wizard-deploy.html"},"Installation Options Reference for Digital.ai Deploy")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-kube.html"},"XL Kube Command Reference"))),(0,l.kt)("p",null,"The last few lines of the command run will be similar following log:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-log"},"For current process files will be generated in the: digitalai/dai-deploy/digitalai/20240108-120535/kubernetes\nGenerated answers file successfully: digitalai/generated_answers_dai-deploy_digitalai_install-20240108-120535.yaml\nStarting install processing.\nSkip creating namespace digitalai, already exists\nGenerated files successfully for PlainK8s installation.\nApplying resources to the cluster!\nSkipping apply the file /tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/template/controller-manager-metrics-service.yaml\nSkipping apply the file /tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/template/custom-resource-definition.yaml\nSkipping apply the file /tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/template/deployment.yaml\nSkipping apply the file /tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/template/leader-election-role.yaml\nSkipping apply the file /tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/template/leader-election-rolebinding.yaml\nSkipping apply the file /tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/template/manager-role.yaml\nSkipping apply the file /tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/template/manager-rolebinding.yaml\nSkipping apply the file /tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/template/proxy-role.yaml\nSkipping apply the file /tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/template/proxy-rolebinding.yaml\nSkipping apply the file /tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/dai-deploy_cr.yaml\nInstall finished successfully!\n")),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"In the next steps we will do updates to the CR yaml file, to reflect all the custom changes that are already available on the on-prem Deploy installation.\nThe changes will go mainly in the custom-resource (CR) yaml file that is in our case: ",(0,l.kt)("inlineCode",{parentName:"p"},"/tmp/dai/digitalai/dai-deploy/digitalai/20240108-120535/kubernetes/dai-deploy_cr.yaml"),",\nwe will refer it from now with ",(0,l.kt)("inlineCode",{parentName:"p"},"dai-deploy_cr.yaml")," name."),(0,l.kt)("p",{parentName:"div"},"At the end of migration, the generated files from this step will be applied on the K8S cluster, so preserve files, maintain yaml formatting, and be careful what you change in the files. "))),(0,l.kt)("h3",{id:"62-resource-configuration"},"6.2. Resource Configuration"),(0,l.kt)("p",null,"Put a changes in the ",(0,l.kt)("inlineCode",{parentName:"p"},"dai-deploy_cr.yaml"),", in each section, according to your previous estimations for the target product installation.\nCheck in the example file ",(0,l.kt)("a",{target:"_blank",href:a(6633).Z},"dai-deploy_cr.yaml")," following sections: "),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.centralConfiguration.resources")," "),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.master.resources")," "),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.worker.resources")," "),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.postgresql.resources")," "),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.rabbitmq.resources")," ")),(0,l.kt)("p",null,"The numbers in the example are not maybe what is required by your requirements."),(0,l.kt)("h3",{id:"63-configuration-file-changes-optional"},"6.3. Configuration file changes (optional)"),(0,l.kt)("p",null,"If you don't have any customization in the configuration files (in the Deploy's conf or centralConfiguration directory), you can skip this section."),(0,l.kt)("p",null,"First check documentation how we manage the configuration files in the operator environment:\n",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-deploy-customize.html"},"Customize Your Site\u2014Custom Configuration of Deploy")),(0,l.kt)("p",null,"In the documentation, it is described how to do changes if you have already had running Deploy on K8S cluster.\nDuring the migration we can do changes directly in the ",(0,l.kt)("inlineCode",{parentName:"p"},"dai-deploy_cr.yaml")," file."),(0,l.kt)("p",null,"The changes from your on-prem configuration files need to go in the templates that you can get from the template directories.\nTo get templates, you can run pods without running the central configuration, master or worker, for example, master configuration:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'kubectl run master-01 -n digitalai --image=xebialabs/xl-deploy:23.3.2 --command -- /bin/bash -c "sleep infinity"\n')),(0,l.kt)("p",null,"After that, you can get the templates from the master pod, similar to the documentation."),(0,l.kt)("p",null,"For any file that you would like to override in the configuration override its template:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Download the template"),(0,l.kt)("li",{parentName:"ol"},"Change the file with custom changes"),(0,l.kt)("li",{parentName:"ol"},"Put the file in the CR ",(0,l.kt)("inlineCode",{parentName:"li"},"dai-deploy_cr.yaml"),", under ")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.centralConfiguration.extraConfiguration")," section."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.master.extraConfiguration")," section."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.worker.extraConfiguration")," section.")),(0,l.kt)("p",null,"Check the example file ",(0,l.kt)("a",{target:"_blank",href:a(6633).Z},"dai-deploy_cr.yaml")," under "),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.centralConfiguration.extraConfiguration")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.master.extraConfiguration")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.worker.extraConfiguration"))),(0,l.kt)("p",null,"sections, there are examples of how to customize:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"central-conf/type-defaults.properties")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"default-conf/deployit-security.xml"))),(0,l.kt)("p",null,"In the same way, you can change any file in the configuration directory."),(0,l.kt)("h3",{id:"64-other-customizations-optional"},"6.4. Other customizations (optional)"),(0,l.kt)("h4",{id:"641-truststore"},"6.4.1. Truststore"),(0,l.kt)("p",null,"If you don't use truststore in your Deploy setup, you can skip this section."),(0,l.kt)("p",null,"Check the documentation how to set up it: ",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-deploy-setup-truststore.html"},"Set up Truststore for Deploy"),".\nInstead of applying the changes on the cluster use update the ",(0,l.kt)("inlineCode",{parentName:"p"},"dai-deploy_cr.yaml")," file directly. "),(0,l.kt)("h4",{id:"642-set-up-jvm-arguments"},"6.4.2. Set up JVM Arguments"),(0,l.kt)("p",null,"If you need to set up some additional JVM arguments, check: ",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-deploy-setup-jvm-arguments.html"},"Set up JVM Arguments for Application Containers"),".\nInstead of applying the changes on the cluster use update the ",(0,l.kt)("inlineCode",{parentName:"p"},"dai-deploy_cr.yaml")," file directly."),(0,l.kt)("h4",{id:"643-set-up-file-logging"},"6.4.3. Set up file logging"),(0,l.kt)("p",null,"In the default setup the Deploy logging is not persisted to the filesystem, you can customize the configuration according to the examples:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://digitalai.atlassian.net/wiki/spaces/Labs/pages/77215137848/Logging+configuration+scan+configuration+values"},"Logging configuration scan & configuration values (not public, ask for the copy)")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://digitalai.atlassian.net/wiki/spaces/Labs/pages/77215137976/File+logging+with+K8s+operator"},"File logging with K8s operator (not public, ask for the copy)"))),(0,l.kt)("h3",{id:"65-test-the-setup-with-temporary-installation-optional"},"6.5. Test the Setup with Temporary Installation (optional)"),(0,l.kt)("p",null,"If you would like, you can test the configuration before using existing or migrated data.\nThe reason for this could to minimize downtime and to observe possible problems before using existing DB.\nIn this section, we will start prepared configuration without any data so we can test that all is ok with our configuration changes."),(0,l.kt)("h4",{id:"651-change-database-configuration-to-temporary-database"},"6.5.1 Change database configuration to temporary database"),(0,l.kt)("p",null,"In case you are using an existing database, and you have already referenced it in the configuration; we need to change it to some other DB.\nCreate some temporary database, or delete the content of the database after this test:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"If you would like use the external ",(0,l.kt)("strong",{parentName:"li"},"temporary")," database: change the configuration to reference it from the section in the ",(0,l.kt)("inlineCode",{parentName:"li"},"dai-deploy_cr.yaml"),": ",(0,l.kt)("inlineCode",{parentName:"li"},"spec.external.db"),"."),(0,l.kt)("li",{parentName:"ul"},"If you would like to use the same external ",(0,l.kt)("strong",{parentName:"li"},"empty")," database, that same in the final installation: you will need to delete the content of the database after this test installation."),(0,l.kt)("li",{parentName:"ul"},"If you have a configuration for PostgreSQL database that is part of the operator installation: you don't need to do anything.")),(0,l.kt)("h4",{id:"652-apply-temporary-installation-to-cluster"},"6.5.2. Apply temporary installation to cluster"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"xl kube install --files 20240108-120535\n")),(0,l.kt)("p",null,"That command should apply all the files that are created by dry-run."),(0,l.kt)("h4",{id:"653-check-the-test-installation"},"6.5.3. Check the Test Installation"),(0,l.kt)("p",null,"See section 7. to validate test installation. "),(0,l.kt)("h4",{id:"654-restore-the-database-configuration"},"6.5.4. Restore the Database Configuration"),(0,l.kt)("p",null,"If you were using for tests external ",(0,l.kt)("strong",{parentName:"p"},"temporary")," database, restore the configuration in the ",(0,l.kt)("inlineCode",{parentName:"p"},"dai-deploy_cr.yaml")," file under section ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.external.db"),"."),(0,l.kt)("p",null,"If you were using for tests an external ",(0,l.kt)("strong",{parentName:"p"},"empty")," database, that is the same as in the final installation:\nyou will need to delete the content of the database after this test installation to restore migration data."),(0,l.kt)("h3",{id:"66-restore-data-to-target-db-optional"},"6.6. Restore Data to Target DB (optional)"),(0,l.kt)("p",null,"If you are using an existing database from the previous installation, no need to do anything here, you are already set database configuration by setting external DB params during dry-run."),(0,l.kt)("p",null,"If the existing DB is not the same that you previously used in on-prem installation, be sure that you migrated the data to the new database, that is not part of this guide. "),(0,l.kt)("p",null,"In case you are using the PostgreSQL DB that is part of the Deploy operator installation, check this steps:"),(0,l.kt)("h4",{id:"661-change-replica-count-for-master-and-worker"},"6.6.1 Change replica count for master and worker"),(0,l.kt)("p",null,"We need first to start the PostgreSQL that is part of the operator installation, but without master and worker running.\nChange the replica count for master and worker, put to ",(0,l.kt)("inlineCode",{parentName:"p"},"0")," values under:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.master.replicaCount")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"spec.worker.replicaCount"))),(0,l.kt)("h4",{id:"662-apply-temporary-installation-to-cluster"},"6.6.2. Apply temporary installation to cluster"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"xl kube install --files 20240108-120535\n")),(0,l.kt)("p",null,"That command should apply all the files that are created by dry-run and start PostgreSQL pod\n(and other pods Deploy operator, RabbitMQ, Central configuration, ingress if enabled). "),(0,l.kt)("h4",{id:"663-restore-the-data"},"6.6.3. Restore the Data"),(0,l.kt)("p",null,"In this case, it is essential that Deploy master and worker were not connected to the database.\nBecause restore will fail with errors about duplicate database entities."),(0,l.kt)("p",null,"For this step, you need to have already prepared dump that is compatible with PostgreSQL restore (check how to do backup in the step: 5.3.).\nBe sure that the target directory on the pod exists (in the example we are using ",(0,l.kt)("inlineCode",{parentName:"p"},"/bitnami/postgresql/backup")," that is mounted to have enough free space)."),(0,l.kt)("p",null,"Execute the code to upload DB dump files to the PostgreSQL pod:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl cp -c postgresql pg_dump-xld-db.sql.gzip digitalai/dai-xld-postgresql-0:/bitnami/postgresql/backup/pg_dump-xld-db.sql.gzip\n# execute this if you have separate xld-report-db\nkubectl cp -c postgresql pg_dump-xld-report-db.sql.gzip digitalai/dai-xld-postgresql-0:/bitnami/postgresql/backup/pg_dump-xld-report-db.sql.gzip\n")),(0,l.kt)("p",null,"Connect to PostgreSQL pod console and restore the data to local DB:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"gunzip -c /bitnami/postgresql/backup/pg_dump-xld-db.sql.gzip | psql -U xld xld-db\n# execute this if you have separate xld-report-db\ngunzip -c /bitnami/postgresql/backup/pg_dump-xld-report-db.sql.gzip | psql -U xld-report xld-report-db\n")),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"Make sure that the directory on Pod where you are storing backup has enough free space."))),(0,l.kt)("h3",{id:"67-apply-the-setup-on-k8s-cluster"},"6.7. Apply the Setup on K8S Cluster"),(0,l.kt)("h3",{id:"671-review-the-dai-deploy_cryaml"},"6.7.1 Review the ",(0,l.kt)("inlineCode",{parentName:"h3"},"dai-deploy_cr.yaml")),(0,l.kt)("p",null,"Review the content of the ",(0,l.kt)("inlineCode",{parentName:"p"},"dai-deploy_cr.yaml"),". "),(0,l.kt)("p",null,"Rollback temporary changes in case you have them:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"replica count from the 6.6.1 step;"),(0,l.kt)("li",{parentName:"ul"},"database configuration from the 6.5.1 step.")),(0,l.kt)("h3",{id:"672-apply-final-installation-to-cluster"},"6.7.2 Apply final installation to cluster"),(0,l.kt)("p",null,"If you have already resources created on the cluster, this step will update them."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"xl kube install --files 20240108-120535\n")),(0,l.kt)("p",null,"That command should apply all the files and start all Deploy pods on cluster."),(0,l.kt)("h2",{id:"7-check-the-installation"},"7. Check the Installation"),(0,l.kt)("h3",{id:"71-check-the-resources"},"7.1 Check the resources"),(0,l.kt)("p",null,"The following command will check and wait to Deploy resources (if they are not yet available on the cluster):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"xl kube check\n")),(0,l.kt)("p",null,"Command will fail if there are missing not-ready resources."),(0,l.kt)("h3",{id:"72-check-the-connection"},"7.2 Check the connection"),(0,l.kt)("p",null,"Check if Deploy master is working correctly by using port-forwarding to the master service (example for digitalai namespace):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl port-forward -n digitalai svc/dai-xld-digitalai-deploy-lb 4516:4516\n")),(0,l.kt)("p",null,"And open in a browser URL: http://localhost:4516/"),(0,l.kt)("p",null,"Or check if ingress (or route) setup is working by opening the URL in a browser that you setup for ingress (or route)."),(0,l.kt)("h2",{id:"8-rollback"},"8. Rollback"),(0,l.kt)("p",null,"In case you are not satisfied with migration, you can go back to the on-prem setup: "),(0,l.kt)("h3",{id:"81-clean-current-installation-from-k8s-cluster"},"8.1. Clean Current Installation from K8S Cluster"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"xl kube clean\n")),(0,l.kt)("p",null,"The command will clean all the resources from the cluster."),(0,l.kt)("h3",{id:"82-start-back-on-prem-deploy"},"8.2. Start back on-prem Deploy"),(0,l.kt)("p",null,"Use the already available installation on-prem Deploy to start it. "),(0,l.kt)("h2",{id:"9-final-notes"},"9. Final Notes"),(0,l.kt)("p",null,"To minimize downtime plan your migration, execute the following steps on the end:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"all the steps from section 5."),(0,l.kt)("li",{parentName:"ul"},"and after that steps 6.6., 6.7.")),(0,l.kt)("p",null,"Additional plugin management after migration can be done by using ",(0,l.kt)("inlineCode",{parentName:"p"},"xl plugin")," commands, check\n",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-deploy-plugin-management.html"},"Manage Plugins in Kubernetes Environment")),(0,l.kt)("p",null,"If you need some additional customization of the Deploy installation, check ",(0,l.kt)("a",{parentName:"p",href:"https://docs.digital.ai/bundle/devops-deploy-version-v.23.3/page/deploy/operator/xl-op-deploy-apply-changes-from-custom-resource.html"},"Update Parameters in the CR File or Deployment")))}c.isMDXComponent=!0},6633:function(e,t,a){t.Z=a.p+"assets/files/dai-deploy_cr-example-f376fd842259acf1d2d0ff623daa6564.yaml"}}]);