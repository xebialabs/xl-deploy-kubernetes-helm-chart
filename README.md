# Helm Charts for Digital.ai Deploy on Openshift 
This repository contains Helm Charts for Digital.ai (formerly Xebialabs) Deploy product. The Helm Chart automates and simplifies deploying Digital.ai Deploy clusters on Kubernetes and other Kubernetes-enabled Platforms such as Openshift by providing the essential features you need to keep your clusters up and running. 

## Prerequisites Details
* Openshift v4+
* A running Openshift cluster
	- Dynamic storage provisioning enabled
	- StorageClass for persistent storage. The [Installing StorageClass Helm Chart](#installing-storageclass-helm-chart) section provides steps to install storage class on OnPremise and AWS Openshift cluster.
	- StorageClass which is expected to be used with Digital.ai Deploy should be set as default StorageClass
- [oc](https://docs.okd.io/latest/cli_reference/openshift_cli/getting-started-cli.html#cli-installing-cli-on-linux_cli-developer-commands) installed and setup to use the cluster
- [Helm](https://helm.sh/docs/intro/install/) 3 installed
- License File for Digital.ai Deploy in base64 encoded format
- Repository Keystorefile in base64 encoded format along with its passphrase

## Chart Details
This chart will deploy following components:
* PostgreSQL single instance / pod 

(**NOTE:** For production grade installations it is recommended to use an external PostgreSQL). Alternatively users may want to install Postgres HA on Openshift. For more information, refer [Crunchy PostgreSQL Operator](https://www.crunchydata.com/products/crunchy-postgresql-for-kubernetes/)
* RabbitMQ in highly available configuration
* Digital.ai Deploy multiple masters and workers
> **Note**: Satellites are expected to be deployed outside the Openshift cluster.
## Tested Configuration
- **Supported Platforms:** - OnPremise Openshift, Openshift on AWS
- **Storage:** - Network File System (NFS), AWS Elastic File System (EFS)
- **Messaging Queue:** - Rabbit MQ 
- **Database:** - Postgresql 
 
## Installing StorageClass Helm Chart
 If you are using storage class other than NFS and EFS then please proceed with installation steps
### NFS Client Provisioner for OnPremise Openshift cluster
* For deploying helm chart, `nfs server` and `nfs mount path` are required.
* Before installing NFS Provisioner helm chart, you need to add the stable helm repository to your helm client as shown below:
```bash
helm repo add stable https://charts.helm.sh/stable
```
* To install the chart with the release name `nfs-provisioner`:
```bash
helm install nfs-provisioner --set nfs.server=x.x.x.x --set nfs.path=/exported/path stable/nfs-client-provisioner
```
* After the helm chart is deployed, appropriate scc(Security Context Constraints) should be assign to the nfs-provisioners service account as shown below. 
```bash
oc adm policy add-scc-to-user hostmount-anyuid -z nfs-provisioner-nfs-client-provisioner
```
* To apply the scc on nfs-client-provisioner, the deployment should be scaled down to 0 and again scale up to 1
```bash
oc scale deployments nfs-provisioner-nfs-client-provisioner â€“replicas=0

oc scale deployments nfs-provisioner-nfs-client-provisioner --replicas=1
```
* The `nfs-provisioner` storage class must be marked with the default annotation so that PersistentVolumeClaim objects (without a StorageClass specified) will trigger dynamic provisioning.
```bash
oc patch storageclass nfs-provisioner -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
```
* After deploying the nfs helm chart, execute the below command to get StorageClass name which can be used in values.yaml file for parameter `Persistence.StorageClass`
```bash
oc get storageclass
```
For more information on nfs-client-provisioner, refer [stable/nfs-client-provisioner](https://github.com/helm/charts/tree/master/stable/nfs-client-provisioner)
### Elastic File System for Openshift cluster on AWS 
Before deploying EFS helm chart, there are some steps which need to be performed.
* Create your EFS file system. Refer [Create Your Amazon EFS File System](https://docs.aws.amazon.com/efs/latest/ug/gs-step-two-create-efs-resources.html) for creating file system.
* Create a mount target. Refer [Creating mount targets](https://docs.aws.amazon.com/efs/latest/ug/accessing-fs.html) for creating mount target.
* Before installing EFS Provisioner helm chart, you need to add the stable helm repository to your helm client as shown below:
```bash
helm repo add stable https://charts.helm.sh/stable
```
* Provide the `efsFileSystemId` and `awsRegion` which can be obtained by executing above steps. Install the chart with the release name `aws-efs`:
```bash
helm install aws-efs stable/efs-provisioner --set efsProvisioner.efsFileSystemId=fs-12345678 --set efsProvisioner.awsRegion=us-east-2
```
* The `aws-efs` storage class must be marked with the default annotation so that PersistentVolumeClaim objects (without a StorageClass specified) will trigger dynamic provisioning.
```bash
oc patch storageclass aws-efs -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
```
* There has to be only one storage class with default setting, so remove other storage classes with default settings.
```bash
oc patch storageclass gp2 -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"false"}}}'
```
* After deploying the efs helm chart, execute the below command to get StorageClass name which can be used in values.yaml file for parameter `Persistence.StorageClass`
```bash
oc get storageclass
```
For more information on efs-provisioner, refer [stable/efs-provisioner](https://github.com/helm/charts/tree/master/stable/efs-provisioner)

## Installing the Digital.ai Deploy Helm Chart
Get the chart by cloning this repository:
```bash
git clone -b ENG-2678 https://github.com/xebialabs/xl-deploy-kubernetes-helm-chart.git
```
The [Parameters](#parameters) section lists the parameters that can be configured before installation starts.
Before installing helm charts, you need to update the dependencies of a chart:
```bash
helm dependency update xl-deploy-kubernetes-helm-chart
```
To install the chart with the release name `xld-production`:
```bash
helm install xld-production xl-deploy-kubernetes-helm-chart
```


## Access Digital.ai Deploy Dashboard
By default, route exposes the service by giving it an externally reachable hostname and can be seen by running below command
```bash
oc get route
```

For OnPremise Cluster, you can access Digital.ai Deploy UI from an outside cluster with below link 

 [http://route-host](http://route-host) 

Similarly for AWS also, access Digital.ai Deploy UI using below link 

 [http://route-host](http://route-host)

## Uninstalling the Digital.ai Deploy Helm Chart
To uninstall/delete the `xld-production` deployment:
```bash
helm delete xld-production
```


## Parameters
For deployment on Production environment, all parameters need to be configured as per users requirement and Openshift setup which is under use. However, for deployment on test environment, most of the default values will suffice. The following parameters are required to be configured and rest of the parameters may remain as default
- *xldLicense*: License for Digital.ai Deploy in base64 format
- *RepositoryKeystore*: The RepositoryKeystore file for Digital.ai Deploy should be converted to the base64 format
- *KeystorePassphrase*: The passphrase for the RepositoryKeystore
- *Persistence.StorageClass*: Storage Class to be defined, Network File System (NFS) for OnPremise or Elastic File System (EFS) for AWS Openshift
- *route.hosts*: Hostname for accessing UI of Digital.ai Deploy


The following table lists the configurable parameters of the Digital.ai Deploy chart and their default values.
Parameter                                          |Description                                                                                                                                                          |Default                                                                                                                                                                                                                                                                                                                                                                        
---------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
XldMasterCount                                     |Number of master replicas                                                                                                                                            |3                                                                                                                                                                                                                                                                                                                                                                              
XldWorkerCount                                     |Number of worker replicas                                                                                                                                            |3                                                                                                                                                                                                                                                                                                                                                                              
ServerImageRepository                              |Image name for the Deploy master                                                                                                                                     |xebialabs/xl-deploy                                                                                                                                                                                                                                                                                                                                                            
WorkerImageRepository                              |Image name for the Deploy worker                                                                                                                                     |xebialabs/deploy-task-engine
ImageTag                                           |Image tag                                                                                                                                                            |9.7                                                                                                                                                                                                                                                                                                                                                                            
ImagePullPolicy                                    |Image pull policy, Defaults to 'Always' if image tag is 'latest',set to 'IfNotPresent'                                                                               |Always                                                                                                                                                                                                                                                                                                                                                                         
ImagePullSecret                                    |Specify docker-registry secret names. Secrets must be manually created in the namespace                                                                              |nil                                                                                                                                                                                                                                                                                                                                                                            
route.Enabled                                      |Use openshift route                                                                            |true                                                                                                                                                                                                                                                                                                                                                                           
route.annotations                                  |Annotations for Route                                                                                                                                    |haproxy.router.openshift.io/cookie_name: SESSION_XLD&nbsp; &nbsp; &nbsp; haproxy.router.openshift.io/disable_cookies: "false"<br>haproxy.router.openshift.io/rewrite-target: / 
route.path                                         |Path component for path based routes                                                                                                     |/                                                                                                                                                                                                                                                                                                                                                                    
route.hosts                                        |Externally-reachable hostname                                                                                                     |app.example.com                                                                                                                                                                                                                                                                                                                                                                   
tls.key                                            |Base64 encoded strings for the tls private key                      |nil                                                                                                                                                                                                                                                                                                                                                                          
tls.certificate                                    |Base64 encoded strings for the tls certificate                      |nil                                                                                                                                                                                                                                                                                                                                                                          
tls.caCertificate                                  |Base64 encoded string for the tls CA certificate                      |nil                                                                                                                                                                                                                                                                                                                                                                          
tls.insecureEdgeTerminationPolicy                  |By default only Edge Termination is supported with Deploy                      |Redirect                                                                                                                                                                                                                                                                                                                                                                          
AdminPassword                                      |Admin password for xl-deploy                                                                                                                                          |If user does not provide password, random 10 character alphanumeric string will be generated                                                                                                                                                                                                                                                                                                                                        
xldLicense                                         |Convert xl-deploy.lic files content to base64                                                                    |nil                                                                                                                                                                                                                                                                                                                                                                            
RepositoryKeystore                                 |Convert keystore.jks files content to base64                                                                      |nil                                                                                                                                                                                                                                                                                                                                                                            
KeystorePassphrase                                 |Passphrase for keystore.jks file                                                                                                                                     |nil                                                                                                                                                                                                                                                                                                                                                                            
resources                                          |CPU/Memory resource requests/limits. User can change the parameter accordingly                                                                                                                                  |nil                                                                                                                                                                                                                                                                                                                                                                            
postgresql.install                                 |Installs postgresql chart with single instance. If you have an existing database deployment, set 'install' to 'false'.                                                                     |true                                                                                                                                                                                                                                                                                                                                                                           
postgresql.postgresqlUsername                      |PostgreSQL user (creates a non-admin user when postgresqlUsername is not postgres)                                                                                   |postgres                                                                                                                                                                                                                                                                                                                                                                       
postgresql.postgresqlPassword                      |PostgreSQL user password                                                                                                                                             |random 10 character alphanumeric string                                                                                                                                                                                                                                                                                                                                        
postgresql.postgresqlExtendedConf.listenAddresses  |Specifies the TCP/IP address(es) on which the server is to listen for connections from client applications                                                           | *                                                                                                                                                                                                                                                                                                                                                                            
postgresql.postgresqlExtendedConf.maxConnections   |Maximum total connections                                                                                                                                            |500                                                                                                                                                                                                                                                                                                                                                                            
postgresql.initdbScriptsSecret                     |Secret with initdb scripts that contain sensitive information (Note: can be used with initdbScriptsConfigMap or initdbScripts). The value is evaluated as a template.|postgresql-init-sql-xlr                                                                                                                                                                                                                                                                                                                                                        
postgresql.service.port                            |PostgreSQL port                                                                                                                                                      |5432                                                                                                                                                                                                                                                                                                                                                                           
postgresql.persistence.enabled                     |Enable persistence using PVC                                                                                                                                         |true                                                                                                                                                                                                                                                                                                                                                                           
postgresql.persistence.size                        |PVC Storage Request for PostgreSQL volume                                                                                                                            |50Gi                                                                                                                                                                                                                                                                                                                                                                            
postgresql.persistence.existingClaim               |Provide an existing PersistentVolumeClaim, the value is evaluated as a template.                                                                                     |nil                                                                                                                                                                                                                                                                                                                                                                            
postgresql.resources                               |CPU/Memory resource requests/limits                                                                                                                                  |Memory: 256Mi, CPU: 250m                                                                                                                                                                                                                                                                                                                                                       
postgresql.nodeSelector                            |Node labels for pod assignment                                                                                                                                       |{}                                                                                                                                                                                                                                                                                                                                                                             
postgresql.affinity                                |Affinity labels for pod assignment                                                                                                                                   |{}                                                                                                                                                                                                                                                                                                                                                                             
postgresql.tolerations                             |Toleration labels for pod assignment                                                                                                                                 |\[\]                                                                                                                                                                                                                                                                                                                                                                           
postgresql.volumePermissions.securityContext.runAsUser|User ID for the init container                                                                                                                                 |auto                                                                                                                                                                                                                                                                                                                                                                           
postgresql.securityContext.enabled                 |Enable security context                                                                                                                                 |false                                                                                                                                                                                                                                                                                                                                                                           
postgresql.containerSecurityContext.enabled        |Enable container security context                                                                                                                                 |false                                                                                                                                                                                                                                                                                                                                                                           
postgresql.shmVolume.chmod.enabled                 |Run at init chmod 777 of the /dev/shm (ignored if volumePermissions.enabled is false)                                                                                                                                 |false                                                                                                                                                                                                                                                                                                                                                                           
UseExistingDB.Enabled                              |If you want to use an existing database, change 'postgresql.install' to 'false'.                                                                                     |false                                                                                                                                                                                                                                                                                                                                                                          
UseExistingDB.XL\_DB\_URL                          |Database URL for xl-deploy                                                                                                                                            |nil                                                                                                                                                                                                                                                                                                                                                                            
UseExistingDB.XL\_DB\_USERNAME                     |Database User for xl-deploy                                                                                                                                           |nil                                                                                                                                                                                                                                                                                                                                                                            
UseExistingDB.XL\_DB\_PASSWORD                     |Database Password for xl-deploy                                                                                                                                       |nil                                                                                                                                                                                                                                                                                                                                                                            
rabbitmq-ha.install                                |Install rabbitmq chart. If you have an existing message queue deployment, set 'install' to 'false'.                                                                  |true                                                                                                                                                                                                                                                                                                                                                                           
rabbitmq-ha.rabbitmqUsername                       |RabbitMQ application username                                                                                                                                        |guest                                                                                                                                                                                                                                                                                                                                                                          
rabbitmq-ha.rabbitmqPassword                       |RabbitMQ application password                                                                                                                                        |random 24 character long alphanumeric string                                                                                                                                                                                                                                                                                                                                   
rabbitmq-ha.rabbitmqErlangCookie                   |Erlang cookie                                                                                                                                        |DEPLOYRABBITMQCLUSTER                                                                                                                                                                                                                                                                                                                                   
rabbitmq-ha.rabbitmqMemoryHighWatermark            |Memory high watermark                                                                                                                                        |500MB                                                                                                                                                                                                                                                                                                                                   
rabbitmq-ha.rabbitmqNodePort                       |Node port                                                                                                                                        |5672                                                                                                                                                                                                                                                                                                                                   
rabbitmq-ha.extraPlugins                           |Additional plugins to add to the default configmap                                                                                                                   | rabbitmq_shovel, rabbitmq_shovel_management, rabbitmq_federation, rabbitmq_federation_management, rabbitmq_jms_topic_exchange, rabbitmq_management,                                                                                                                                                                                                   
rabbitmq-ha.replicaCount                           |Number of replica                                                                                                                                                    |3                                                                                                                                                                                                                                                                                                                                                                              
rabbitmq-ha.rbac.create                            |If true, create & use RBAC resources                                                                                                                                 |true                                                                                                                                                                                                                                                                                                                                                                           
rabbitmq-ha.service.type                           |Type of service to create                                                                                                                                            |ClusterIP                                                                                                                                                                                                                                                                                                                                                                      
rabbitmq-ha.persistentVolume.enabled               |If true, persistent volume claims are created                                                                                                                        |true                                                                                                                                                                                                                                                                                                                                                                          
rabbitmq-ha.persistentVolume.size                  |Persistent volume size                                                                                                                                               |20Gi                                                                                                                                                                                                                                                                                                                                                                            
rabbitmq-ha.persistentVolume.annotations           |Persistent volume annotations                                                                                                                                        |{}                                                                                                                                                                                                                                                                                                                                                                             
rabbitmq-ha.persistentVolume.resources             |CPU/Memory resource requests/limits                                                                                                                                  |{}                                                                                                                                                                                                                                                                                                                                                                             
rabbitmq-ha.definitions.policies                   |HA policies to add to definitions.json                                                                                                                               | `{"name": "ha-all","pattern": ".*","vhost": "/","definition": {"ha-mode": "all","ha-sync-mode": "automatic", "ha-sync-batch-size": 1 } }`                                                                                                                                                                                                      
rabbitmq-ha.definitions.globalParameters           |Pre-configured global parameters                                                                                                                                     |`{"name": "cluster_name", "value": "" }`                                                                                                                                                                                                                                                                                                                                
rabbitmq-ha.prometheus.operator.enabled            |Enabling Prometheus Operator                                                                                                                                         |false                                                                                                                                                                                                                                                                                                                                                                          
UseExistingMQ.Enabled                              |If you want to use an existing Message Queue, change 'rabbitmq-ha.install' to 'false'                                                                                |false                                                                                                                                                                                                                                                                                                                                                                          
UseExistingMQ.XLD\_TASK\_QUEUE\_USERNAME           |Username for xl-deploy task queue                                                                                                                                     |nil                                                                                                                                                                                                                                                                                                                                                                            
UseExistingMQ.XLD\_TASK\_QUEUE\_PASSWORD           |Password for xl-deploy task queue                                                                                                                                     |nil                                                                                                                                                                                                                                                                                                                                                                            
UseExistingMQ.XLD\_TASK\_QUEUE\_URL                |URL for xl-deploy task queue                                                                                                                                          |nil                                                                                                                                                                                                                                                                                                                                                                            
UseExistingMQ.XLD\_TASK\_QUEUE\_DRIVER\_CLASS\_NAME|Driver Class Name for xl-deploy task queue                                                                                                                            |nil                                                                                                                                                                                                                                                                                                                                                                            
HealthProbes                                       |Would you like a HealthProbes to be enabled                                                                                                                          |true                                                                                                                                                                                                                                                                                                                                                                           
HealthProbesLivenessTimeout                        |Delay before liveness probe is initiated                                                                                                                             |90                                                                                                                                                                                                                                                                                                                                                                             
HealthProbesReadinessTimeout                       |Delay before readiness probe is initiated                                                                                                                            |90                                                                                                                                                                                                                                                                                                                                                                             
HealthProbeFailureThreshold                        |Minimum consecutive failures for the probe to be considered failed after having succeeded                                                                            |12                                                                                                                                                                                                                                                                                                                                                                             
HealthPeriodScans                                  |How often to perform the probe                                                                                                                                       |10                                                                                                                                                                                                                                                                                                                                                                             
nodeSelector                                       |Node labels for pod assignment                                                                                                                                       |{}                                                                                                                                                                                                                                                                                                                                                                             
tolerations                                        |Toleration labels for pod assignment                                                                                                                                 |\[\]                                                                                                                                                                                                                                                                                                                                                                           
affinity                                           |Affinity labels for pod assignment                                                                                                                                   |{}                                                                                                                                                                                                                                                                                                                                                                             
Persistence.Enabled                                |Enable persistence using PVC                                                                                                                                         |true                                                                                                                                                                                                                                                                                                                                                                           
Persistence.StorageClass                           |PVC Storage Class for volume                                                                                                                                         |nil                                                                                                                                                                                                                                                                                                                                                                            
Persistence.Annotations                            |Annotations for the PVC                                                                                                                                              |{}                                                                                                                                                                                                                                                                                                                                                                             
Persistence.AccessMode                             |PVC Access Mode for volume                                                                                                                                           |ReadWriteOnce                                                                                                                                                                                                                                                                                                                                                                  
Persistence.XldExportPvcSize                       |XLD Master PVC Storage Request for volume. For production grade setup, size must be changed                                                                          |10Gi                                                                                                                                                                                                                                                                                                                                                                            
Persistence.XldWorkPvcSize                         |XLD Worker PVC Storage Request for volume. For production grade setup, size must be changed                                                                          |5Gi                                                                                                                                                                                                                                                                                                                                                                            

## Upgrading the Digital.ai Deploy Helm Chart
To upgrade the version `ImageTag` parameter needs to be updated to the desired version. To see the list of available ImageTag for Digital.ai Deploy, refer the following links [Deploy_tags](https://hub.docker.com/r/xebialabs/xl-deploy/tags). For upgrade, Rolling Update strategy is used.
To upgrade the chart with the release name `xld-production`, execute below command: 
```bash
helm upgrade xld-production xl-deploy-kubernetes-helm-chart/
```
> **Note**:
	Currently upgrading custom plugins and database drivers is not supported. In order to upgrade custom plugins and database drivers, users need to build custom docker image of Digital.ai Deploy containing required files.See the [adding custom plugins](https://docs.xebialabs.com/v.9.7/deploy/how-to/customize-xl-up/#adding-custom-plugins) section in the the Digital.ai (formerly Xebialabs) official documentation.
	
### Existing or External Databases
There is an option to use external PostgreSQL database for your Digital.ai Deploy.
Configure values.yaml file accordingly.
If you want to use an existing database,  these steps need to be followed:
- Change `postgresql.install` to false
- `UseExistingDB.Enabled`: true
- `UseExistingDB.XL_DB_URL`: `jdbc:postgresql://<postgres-service-name>:5432/<xld-database-name>`
- `UseExistingDB.XL_DB_USERNAME`: Database User for xl-deploy
- `UseExistingDB.XL_DB_PASSWORD`: Database Password for xl-deploy

**Example:**
```bash
#Passing a custom PostgreSQL to XL-Deploy
UseExistingDB:
  Enabled: true
  # If you want to use existing database, change the value to "true".
  # Uncomment the following lines and provide the values.
  XL_DB_URL: jdbc:postgresql://xld-production-postgresql:5432/xld-db
  XL_DB_USERNAME: postgres
  XL_DB_PASSWORD: postgres
```  
> **Note**: User might have database instance running outside the cluster. Configure parameters accordingly.
### Existing or External Messaging Queue
If you plan to use an existing messaging queue, follow these steps to configure values.yaml
- Change `rabbitmq-ha.install` to false
- `UseExistingMQ.Enabled`: true
- `UseExistingMQ.XLD_TASK_QUEUE_USERNAME`: Username for xl-deploy task queue
- `UseExistingMQ.XLD_TASK_QUEUE_PASSWORD`: Password for xl-deploy task queue
- `UseExistingMQ.XLD_TASK_QUEUE_URL`: `amqp://<rabbitmq-service-name>:5672`
- `UseExistingMQ.XLD_TASK_QUEUE_DRIVER_CLASS_NAME`: Driver class name for  xl-deploy task queue

**Example:**
```bash
# Passing a custom RabbitMQ to XL-Deploy
UseExistingMQ:
  Enabled: true
  # If you want to use an existing Message Queue, change 'rabbitmq-ha.install' to 'false'.
  # Set 'UseExistingMQ.Enabled' to 'true'.Uncomment the following lines and provide the values.
  XLD_TASK_QUEUE_USERNAME: guest
  XLD_TASK_QUEUE_PASSWORD: guest
  XLD_TASK_QUEUE_URL: amqp://xld-production-rabbitmq-ha:5672/%2F
  XLD_TASK_QUEUE_DRIVER_CLASS_NAME: com.rabbitmq.jms.admin.RMQConnectionFactory
```
> **Note**: User might have rabbitmq instance running outside the cluster. Configure parameters accordingly.


## Useful links
- [`xebialabs/xl-deploy:<tagname>`](https://hub.docker.com/r/xebialabs/xl-deploy) â€“ Docker Hub repository for Digital.ai Deploy
- [`stable/rabbitmq-ha`](https://github.com/helm/charts/tree/master/stable/rabbitmq-ha) -  Github repository for RabbitMQ Helm Chart
- [`bitnami/postgresql`](https://github.com/bitnami/charts/tree/master/bitnami/postgresql) -  Github repository for Postgresql Helm Chart

